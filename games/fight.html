<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fighting Game</title>
<style>
body { margin:0; font-family:sans-serif; background:#222; color:white; display:flex; justify-content:center; align-items:center; height:100vh; }
.screen { display:none; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; }
.screen.active { display:flex; }
button { padding:10px 20px; margin:10px; font-size:18px; cursor:pointer; }
.box-container { display:flex; flex-wrap:wrap; justify-content:center; margin-top:20px; }
.box { width:120px; height:50px; margin:10px; display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; }
.selected { border:4px solid gold; }
canvas { border:3px solid white; background:black; }
</style>
</head>
<body>

<!-- MAIN MENU -->
<div id="mainMenu" class="screen active">
  <h1>Fighting Game</h1>
  <h2>Select Mode</h2>
  <button onclick="chooseMode('Stocks')">Stocks</button>
  <button onclick="chooseMode('Time')">Time</button>
</div>

<!-- MAP SELECT SCREEN -->
<div id="mapSelectScreen" class="screen">
  <h2>Select Map</h2>
  <div id="mapBoxes" class="box-container"></div>
  <button id="mapNextBtn">Next</button>
</div>

<!-- CHARACTER SELECT SCREEN -->
<div id="charSelectScreen" class="screen">
  <h2>Select Characters</h2>
  <canvas id="charCanvas" width="900" height="400"></canvas>
  <div style="display:flex; justify-content:space-between; width:850px; margin-top:10px;">
    <div id="p1Box">Player 1: None</div>
    <div id="p2Box">Player 2: None</div>
  </div>
  <button id="confirmCharsBtn">Confirm</button>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <canvas id="gameCanvas" width="900" height="500"></canvas>
</div>

<script>
const maps=[
  {name:'Computer', color:'#808080', hazardY:400},
  {name:'Clouds', color:'#FFFFFF', hazardY:380},
  {name:'Shop', color:'#A52A2A', hazardY:420},
  {name:'Public', color:'#8B0000', hazardY:390},
  {name:'Room', color:'#E0BFB8', hazardY:410},
  {name:'Tree', color:'#228B22', hazardY:360},
  {name:'Yard', color:'#F5F5DC', hazardY:400},
  {name:'Work', color:'#1B1B1B', hazardY:400},
  {name:'House', color:'#FFFDD0', hazardY:370},
  {name:'Heaven', color:'#FF2400', hazardY:430}
];
const characters=[
  {name:"The Creator", color:'silver'},
  {name:"Pru", color:'green'},
  {name:"Uncle R", color:'tan'},
  {name:"Robe Guy", color:'purple'},
  {name:"Sis", color:'cyan'},
  {name:"Sunny", color:'orange'},
  {name:"Winston", color:'#D2691E'},
  {name:"Mom", color:'pink'},
  {name:"Dad", color:'blue'},
  {name:"God", color:'gold'}
];

// SCREENS
const mainMenu=document.getElementById('mainMenu');
const mapSelectScreen=document.getElementById('mapSelectScreen');
const charSelectScreen=document.getElementById('charSelectScreen');
const gameScreen=document.getElementById('gameScreen');
const charCanvas=document.getElementById('charCanvas');
const charCtx=charCanvas.getContext('2d');
const gameCanvas=document.getElementById('gameCanvas');
const ctx=gameCanvas.getContext('2d');

// UI
const mapBoxesDiv=document.getElementById('mapBoxes');
const mapNextBtn=document.getElementById('mapNextBtn');
const confirmCharsBtn=document.getElementById('confirmCharsBtn');
const p1Box=document.getElementById('p1Box');
const p2Box=document.getElementById('p2Box');

// GAME STATE
let gameMode='Stocks';
let selectedMap=null;
let selectedP1=null;
let selectedP2=null;
let gameRunning=false;
let keys={};
let gravity=1.2;
let timeLimit=60;
let timeElapsed=0;

// PLAYER CLASS
class Player{
  constructor(name,color,x,y,controls){
    this.name=name; this.color=color; this.x=x; this.y=y;
    this.width=50; this.height=50; this.vx=0; this.vy=0;
    this.hp=100; this.controls=controls; this.onGround=false;
    this.attackCooldown=0; this.specialCooldown=0;
    this.stocks=3; this.invincible=0; this.kills=0;
  }
  update(){
    if(keys[this.controls.left]) this.vx=-5;
    else if(keys[this.controls.right]) this.vx=5;
    else this.vx=0;
    if(keys[this.controls.up] && this.onGround){ this.vy=-18; this.onGround=false; }
    this.vy+=gravity; this.x+=this.vx; this.y+=this.vy;
    if(this.y+this.height>selectedMap.hazardY){ this.y=selectedMap.hazardY-this.height; this.vy=0; this.onGround=true; }

    if(keys[this.controls.attack] && this.attackCooldown<=0){
      if(this===player1 && hit({x:this.x+this.width,y:this.y,width:20,height:this.height},player2)) player2.takeDamage(10);
      if(this===player2 && hit({x:this.x-20,y:this.y,width:20,height:this.height},player1)) player1.takeDamage(10);
      this.attackCooldown=20;
    } else if(this.attackCooldown>0) this.attackCooldown--;

    if(keys[this.controls.special] && this.specialCooldown<=0){
      if(this===player1 && hit({x:this.x+this.width,y:this.y-20,width:70,height:70},player2)) player2.takeDamage(25);
      if(this===player2 && hit({x:this.x-70,y:this.y-20,width:70,height:70},player1)) player1.takeDamage(25);
      this.specialCooldown=180;
    } else if(this.specialCooldown>0) this.specialCooldown--;

    if(this.x+this.width<0||this.x>gameCanvas.width||this.y>gameCanvas.height||this.y+this.height<0) this.loseStock();
    if(this.invincible>0) this.invincible--;
  }
  takeDamage(amount){ if(this.invincible>0) return; this.hp-=amount; if(this.hp<=0) this.loseStock(); }
  loseStock(){
    if(gameMode==='Stocks'){
      this.stocks--;
      if(this.stocks>0){ this.hp=100; this.x=this===player1?100:750; this.y=300; this.vx=0; this.vy=0; this.invincible=120; }
      else { gameRunning=false; showEndScreen(this===player1?player2:player1); }
    } else if(gameMode==='Time'){
      if(this===player1) player2.kills++; else player1.kills++;
      this.hp=100; this.x=this===player1?100:750; this.y=300; this.vx=0; this.vy=0; this.invincible=120;
    }
  }
  draw(){ ctx.fillStyle=(this.invincible>0)?'white':this.color; ctx.fillRect(this.x,this.y,this.width,this.height); }
}
function hit(a,b){ return a.x<b.x+b.width && a.x+a.width>b.x && a.y<b.y+b.height && a.y+a.height>b.y; }

document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);

// SCREEN FLOW
function chooseMode(mode){
  gameMode=mode;
  mainMenu.classList.remove('active');
  mapSelectScreen.classList.add('active');
  drawMapBoxes();
}

// MAP SELECTION
function drawMapBoxes(){
  mapBoxesDiv.innerHTML='';
  maps.forEach(map=>{
    const div=document.createElement('div');
    div.classList.add('box'); div.style.background=map.color; div.innerText=map.name;
    div.onclick=()=>{
      selectedMap=map;
      document.querySelectorAll('#mapBoxes .box').forEach(b=>b.classList.remove('selected'));
      div.classList.add('selected');
    };
    mapBoxesDiv.appendChild(div);
  });
}
mapNextBtn.onclick=()=>{
  if(!selectedMap) return;
  mapSelectScreen.classList.remove('active');
  charSelectScreen.classList.add('active');
  drawCharSelect();
}

// CHARACTER SELECT
function drawCharSelect(){
  charCtx.clearRect(0,0,charCanvas.width,charCanvas.height);
  charCtx.fillStyle='black'; charCtx.fillRect(0,0,charCanvas.width,charCanvas.height);
  const startX=50,startY=50,boxW=120,boxH=50,gap=10;
  characters.forEach((char,i)=>{
    const x=startX+(i%5)*(boxW+gap);
    const y=startY+Math.floor(i/5)*(boxH+gap);
    charCtx.fillStyle=char.color; charCtx.fillRect(x,y,boxW,boxH);
    charCtx.fillStyle='black'; charCtx.font='16px sans-serif'; charCtx.textAlign='center';
    charCtx.fillText(char.name,x+boxW/2,y+boxH/2+6);
    if(selectedP1===char || selectedP2===char){ charCtx.strokeStyle='gold'; charCtx.lineWidth=4; charCtx.strokeRect(x,y,boxW,boxH); }
  });
  p1Box.innerText='Player 1: '+(selectedP1?selectedP1.name:'None');
  p2Box.innerText='Player 2: '+(selectedP2?selectedP2.name:'None');
}
charCanvas.addEventListener('click',(e)=>{
  const rect=charCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left; const my=e.clientY-rect.top;
  const startX=50,startY=50,boxW=120,boxH=50,gap=10;
  characters.forEach((char,i)=>{
    const x=startX+(i%5)*(boxW+gap);
    const y=startY+Math.floor(i/5)*(boxH+gap);
    if(mx>=x && mx<=x+boxW && my>=y && my<=y+boxH){
      if(!selectedP1) selectedP1=char;
      else if(!selectedP2) selectedP2=char;
      else if(mx<charCanvas.width/2) selectedP1=char; else selectedP2=char;
      drawCharSelect();
    }
  });
});
confirmCharsBtn.onclick=()=>{
  if(!selectedP1 || !selectedP2) return;
  charSelectScreen.classList.remove('active');
  gameScreen.classList.add('active');
  startGame();
}

// GAME LOGIC
let player1=null,player2=null;
function startGame(){
  timeElapsed=0;
  const stocks=3;
  player1=new Player(selectedP1.name,selectedP1.color,100,300,{left:'a',right:'d',up:'w',attack:'f',special:'g'});
  player2=new Player(selectedP2.name,selectedP2.color,750,300,{left:'ArrowLeft',right:'ArrowRight',up:'ArrowUp',attack:'l',special:'k'});
  player1.stocks=stocks; player2.stocks=stocks; player1.kills=0; player2.kills=0;
  gameRunning=true; requestAnimationFrame(gameLoop);
}

function drawMap(){ ctx.fillStyle=selectedMap.color; ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height); ctx.fillStyle='darkred'; ctx.fillRect(0,selectedMap.hazardY,gameCanvas.width,gameCanvas.height-selectedMap.hazardY); ctx.fillStyle='white'; ctx.font='20px sans-serif'; ctx.fillText(`Map: ${selectedMap.name}`,10,30); }
function drawHUD(){ ctx.fillStyle='red'; ctx.fillRect(50,10,player1.hp*2,20); ctx.fillRect(650,10,player2.hp*2,20); ctx.fillStyle='white'; if(gameMode==='Stocks'){ ctx.fillText(`Stocks: ${player1.stocks}`,50,50); ctx.fillText(`Stocks: ${player2.stocks}`,650,50);} else if(gameMode==='Time'){ const timeLeft=Math.max(0,timeLimit-timeElapsed); ctx.fillText(`Time: ${Math.ceil(timeLeft)}s`,380,30); ctx.fillText(`${player1.name} KOs: ${player1.kills}`,50,50); ctx.fillText(`${player2.name} KOs: ${player2.kills}`,650,50); } }

function showEndScreen(winner){
  gameScreen.classList.remove('active');
  const endDiv=document.createElement('div');
  endDiv.classList.add('screen','active'); endDiv.style.flexDirection='column';
  endDiv.innerHTML=`<h1 style="color:${winner.color}; font-size:60px;">${winner.name} Wins!</h1><div style="font-size:50px;">🏆 🏆 🏆</div><button id="backMenuBtn">Back to Main Menu</button>`;
  document.body.appendChild(endDiv);
  document.getElementById('backMenuBtn').onclick=()=>{
    document.body.removeChild(endDiv);
    mainMenu.classList.add('active'); selectedP1=null; selectedP2=null; selectedMap=null;
  }
}

// GAME LOOP
let lastTime=0;
function gameLoop(timestamp){
  if(!gameRunning) return;
  const delta=(timestamp-lastTime)/1000; lastTime=timestamp;
  ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
  drawMap(); player1.update(); player2.update(); player1.draw(); player2.draw(); drawHUD();
  if(gameMode==='Time'){ timeElapsed+=delta; if(timeElapsed>=timeLimit){ gameRunning=false; const winner=player1.kills>player2.kills?player1:player2; showEndScreen(winner); return; } }
  requestAnimationFrame(gameLoop);
}
</script>

</body>
</html>
